!function(a,s){"use strict";var i=a.Read;a.inherit("Read.Analyser","Common.Publisher",function(t){this.node=(t=t||{}).node,this.url=t.url,this.urlReplace=t.urlReplace||[],this.media=t.media,this.device=t.device,this.referrer=t.referrer,this.popInUserId=t.popInUserId,this.apiHost=t.apiHost,this.pageCategory=t.pageCategory,this.commonCategory=t.commonCategory,this.customField=t.customField,this.sessionHistory=t.sessionHistory,this.country=t.country,this.articleReadId=t.articleReadId,this.isClickedAd=t.isClickedAd||!1,this.ignoredNodeNames=t.ignoredNodeNames||void 0,this.campaign=t.campaign,this.nid=t.nid,this.clickCategory=t.clickCategory,this.textSpeed=t.textSpeed,this.imageSpeed=t.imageSpeed,this.isDebug=t.isDebug||!1,this.isNewSession=t.isNewSession||!1,this.sendLogTiming=t.sendLogTiming,this.stopNode=t.stopNode,this.logger=t.logger,this.articleArea,this.retargetingMessenger,this.debug,this.updateCount=0,this.isCompleted=!1,this._currentTimeForLog=0,this._currentReadingPercentageForLog=void 0,this._sentLogs={},this._mainCategoryForTreasure,this.shouldSendPaidLog=!1,this.enabled=!1},{IGNORED_NODE_NAMES:["A","IFRAME","SCRIPT","H1","H2","H3","H4","NOSCRIPT","STYLE"],MIN_IMAGE_AREA:4e4,TEXT_MIN_LENGTH:5,PERCENTAGE_TO_REGARD_IMAGE:.4,PARTITION_HEIGHT:10,READ_HISTORY_SESSION_STORAGE_KEY:"__read",RETARGETING_PAGE_URL:a.PROTOCOL+"//api.popin.cc/iframe/article_read.html",setup:function(){this.shouldSendPaidLog=/paid_/.test(this.referrer),this._tdTrackValues=this.logger.getTrackValues(),this._mainCategoryForTreasure=this._generateMainCategory(this.commonCategory);var t=this._initialiseModules(this.node),e=t.articleArea,i=a.Common.Utils,s=100*Math.round(e.textCount/100),n=Math.round(100*e.imagePartitionCount/e.partitions.length),r=this._generateInOutValues(s,n);this._allR3Value=i.generateBasicLogValue(r),this._readStatValues=this._generateReadStatValues(r),this._outR=r.out_r,this._inTextValue=s,this._inImageValue=n,void 0!==this.articleReadId&&((n=new a.Common.Messenger({url:this.RETARGETING_PAGE_URL})).setup(),this.retargetingMessenger=n),this.articleArea=e,this.debug=t.debug,this.isCompleted=!1,this._currentTimeForLog=0,this._currentReadingPercentageForLog=void 0,this._sentLogs={},this.enabled=!0},_initialiseModules:function(t){var e,t=new i.ArticleArea({node:t,stopNode:this.stopNode,dividingHeight:this.PARTITION_HEIGHT,ignoredNodeNames:this.ignoredNodeNames||this.IGNORED_NODE_NAMES,minImageArea:this.MIN_IMAGE_AREA,textMinLength:this.TEXT_MIN_LENGTH,imageAreaPercentage:this.PERCENTAGE_TO_REGARD_IMAGE,textSpeed:this.textSpeed,imageSpeed:this.imageSpeed});return t.setup(),!0===this.isDebug&&(e=new i.Debug({width:t.width,height:t.height,x:t.left,y:t.top,country:this.country})).setup(),{articleArea:t,debug:e}},_generateInOutValues:function(t,e){var i=(this.sessionHistory||"").split("|");return{text:t,image:e,in_text:t,in_image:e,out_text:i[0]||void 0,out_image:i[1]||void 0,out_r:i[2]||void 0}},_generateReadStatValues:function(t){var e,i={};for(e in t)i["read_stat_"+e]=Number(t[e]);return i},_generateMainCategory:function(t){if("string"==typeof t&&0!==t.length){t=t.split("_");return 0<t.length?t[0]:void 0}},update:function(t,e,i){this.trigger("analyse",null,this),!1!==this._updateEnabled()&&(this.updateCount++,t=this.articleArea.update(t,e,i),!0===this.isDebug&&this.debug.update(t,e,i),!1!==t&&(1<=t.currentReadingPercentage&&(this.isCompleted=!0),this.trigger("update",t,this),!1!==this._isTimingToSendLog()&&(i=a.Common.Utils.replaceAll(s.href,this.urlReplace),this.url!==i&&(this.url=i),this._sendOneTimeOnlyLogs(t),t=(i=this._formatResultValuesForLog(t)).currentPercentage,!1!==this._sendIntervalLogs(i)&&(this._saveHistory(this._inTextValue+"|"+this._inImageValue+"|"+t),this._currentTimeForLog=i.currentTime,this._currentReadingPercentageForLog=t,void 0!==this.retargetingMessenger&&this._sendArticleRetargetingLog(i),this.trigger("logged",i,this)))))},_sendArticleRetargetingLog:function(t){this.retargetingMessenger.send({action:"updateArticleRead",payload:{articleId:this.articleReadId,readPercent:t.currentPercentage}})},_updateEnabled:function(){var t=this._checkWhetherNodeIsValid(this.node);return!0===this.isDebug&&this.debug.changeEnabled(t),this.enabled=t},_checkWhetherNodeIsValid:function(t){return"object"==typeof t&&0<t.clientHeight&&0<t.clientWidth},_sendOneTimeOnlyLogs:function(t){this._sendOneTimeOnlyLogIfConditionIsMet("paidLog",!0===this.shouldSendPaidLog,"_sendPaidLog"),this._sendOneTimeOnlyLogIfConditionIsMet("viewAll",1<=t.currentViewingPercentage,"_sendViewAllLog"),this._sendOneTimeOnlyLogIfConditionIsMet("read70",.7<=t.currentReadingPercentage&&void 0!==this.nid&&void 0!==this.clickCategory,"_sendRead70Log")},_formatResultValuesForLog:function(t){var e=10*Math.round(10*t.currentReadingPercentage),i=this._currentReadingPercentageForLog,s=void 0===i;return{isFirstLog:s,currentTime:t.currentReadingTime,previousTime:this._currentTimeForLog,currentPercentage:e,previousPercentage:s?0:i}},_sendIntervalLogs:function(t){var e=t.currentPercentage;if(e<=0||!1===t.isFirstLog&&e===t.previousPercentage)return!1;this._sendBasicLog(t),this._sendTreasureLog(t.currentTime,e)},_sendOneTimeOnlyLogIfConditionIsMet:function(t,e,i){!0!==this._sentLogs[t]&&!1!==e&&(this[i](),this._sentLogs[t]=!0)},_isTimingToSendLog:function(){return this.updateCount%this.sendLogTiming==0},_sendTreasureLog:function(t,e){var i=s.host;this.logger.send("treasure",{db:"popin_media",table:"readlogs",data:Object.assign({image:this.imageUrl||"",pubdate:this.pubdate||"",category:this.pageCategory||"",read_re:this.referrer,read_cc:this.commonCategory,read_ca:this.pageCategory,read_au:this.customField,campaign:this.campaign,main_category:this._mainCategoryForTreasure,popin_user_id:this.popInUserId,domain:i,media:this.media||i,nid:this.nid,device:this.device,api_host:this.apiHost||"jp.popin.cc",read:e,read_time:Math.round(10*t)/10},this._readStatValues,this._tdTrackValues)})},_sendViewAllLog:function(){var t=this.device;this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:t+"_viewall",nid:t,media:this.media,r5:a.Common.Utils.generateR5Value({ca:this.pageCategory,au:this.customField})}})},_sendRead70Log:function(){this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:this.device+"_read70",nid:this.nid,campaign:this.campaign,media:this.media,r5:this.clickCategory}})},_sendPaidLog:function(){this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:this.referrer}})},_sendBasicLog:function(t){var e=t.currentTime,i=t.previousTime,s=t.isFirstLog;this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:this.popInUserId,nid:this.nid,media:this.media,r1:t.currentPercentage,r2:t.previousPercentage,r3:s?this._allR3Value:"text"+this._inTextValue+"|image"+this._inImageValue,r4:Math.round(e-i),r5:this._generateReadR5ValueForStatusLog(s),r6:Math.round(e),r7:-Math.round(i),r8:s?this.articleArea.totalRequiredTime:void 0}})},_saveHistory:function(t){a.Common.Storage.set("session",this.READ_HISTORY_SESSION_STORAGE_KEY,t)},_generateReadR5Value:function(t){return t.filter(function(t){return void 0!==t}).map(function(t){return encodeURIComponent(t)}).join("|")},_generateReadR5ValueForStatusLog:function(t){return this._generateReadR5Value(["string"==typeof this.pageCategory?"ca_"+this.pageCategory:void 0,"string"==typeof this.customField?"au_"+this.customField:void 0,"string"==typeof this.referrer?"re_"+this.referrer:void 0,"dv_"+this.device,t&&this._outR?"out_r"+this._outR:void 0,t&&!0===this.isNewSession?"session":void 0,t?"sstorage":void 0,this.clickCategory])}})}(window.PopIn,window.location),function(h){"use strict";var a=h.Read,o=Node.ELEMENT_NODE,d=Node.TEXT_NODE;h.createClass("Read.ArticleArea",function(t){this.node=(t=t||{}).node,this.stopNode=t.stopNode,this.width,this.height,this.top,this.left,this.right,this.bottom,this.containedImageNodes,this.totalRequiredTime,this.totalRequiredTimeForReading,this.totalRequiredTimeForViewingImage,this.textSpeed=t.textSpeed,this.imageSpeed=t.imageSpeed,this.dividingHeight=t.dividingHeight,this.ignoredNodeNames=t.ignoredNodeNames||[],this.minImageArea=t.minImageArea||0,this.textMinLength=t.textMinLength||0,this.imageAreaPercentage=t.imageAreaPercentage||0,this.partitions=[],this.area=0,this.currentReadingTime=0,this.currentReadingPercentage=0,this.currentViewingPercentage=0,this.textPartitionCount=0,this.imagePartitionCount=0},{setup:function(){var t=h.Common.Utils,e=this.node,i=t.getSize(e),s=t.getPosition(e),n=this._countText(e),r=this._getTextBottom(e),a=r-s.top,o=0<a?a:i.height,t=this._getValidImageNodes(Array.apply(null,e.getElementsByTagName("img"))),a=this._calculateNodesArea(t),e=n/this.textSpeed,a=a/this.imageSpeed;this.width=i.width,this.height=o,this.top=s.top,this.left=s.left,this.right=s.right,this.bottom=r||s.bottom,this.containedImageNodes=t,this.textCount=n,this.totalRequiredTime=e+a,this.totalRequiredTimeForReading=e,this.totalRequiredTimeForViewingImage=a;a=this._generatePartitionInformation();this.partitions=a.partitions,this.textPartitionCount=a.textPartitionCount,this.imagePartitionCount=a.imagePartitionCount,this.area=a.area},update:function(t,e,i){var s=this._getVisiblePartition(e,i),n=s.length;if(0===n)return!1;for(var r,a=t/(n*this.area),o=0,h=!1;o<n;)(r=s[o]).update(a),h=h||r.isUpdated,o++;if(!1===h)return!1;i=this._calculateTotalPercentages(this.partitions);return{partitions:this.partitions,currentReadingTime:this.currentReadingTime=Math.min(this.currentReadingTime+t,this.totalRequiredTime),currentReadingPercentage:this.currentReadingPercentage=i.currentReadingPercentage,currentViewingPercentage:this.currentViewingPercentage=i.currentViewingPercentage}},_countText:function(t){var e=0;switch(t.nodeType){case o:if(this.stopNode===t)return!1;if(this._isIgnoredNode(t))return 0;for(var i,s=t.childNodes,n=0,r=s.length;n<r;n++){if(!1===(i=this._countText(s[n])))return e;e+=i}break;case d:e=this._eraseText(t.textContent).length}return e},_getTextBottom:function(t,e){switch(e=e||0,t.nodeType){case o:if(this.stopNode===t)return!1;if(this._isIgnoredNode(t))return e;for(var i,s=t.childNodes,n=0,r=s.length;n<r;n++){if(!1===(i=this._getTextBottom(s[n],e)))return e;e=i}break;case d:this._eraseText(t.textContent).length>this.textMinLength&&(e=Math.max(e,this._getBottom(t.parentNode)))}return e},_getValidImageNodes:function(t){return t.filter(this._isValidImageNode.bind(this))},_isValidImageNode:function(t){return h.Common.Utils.calculateNodeArea(t)>=this.minImageArea},_calculateNodesArea:function(t){for(var e=0,i=h.Common.Utils,s=0,n=t.length;s<n;s++)e+=i.calculateNodeArea(t[s]);return e},_getBottom:function(t){var e=h.Common.Utils;return(e.getPosition(t).top||0)+(e.getSize(t).height||0)},_isIgnoredNode:function(t){return h.Common.Utils.includes(t.nodeName,this.ignoredNodeNames)},_eraseText:function(t){return t.replace(/[\n\r\s]/g,"")},_generatePartitionInformation:function(){for(var t,e,i=this.top,s=this.left,n=this.height,r=this.width,a=Math.floor(n/this.dividingHeight),o=n/a,h=[],d=0,u=0,c=0;d<a;)e=i+o*d,!0===(t=this._generatePartition(Math.round(e),Math.round(o+e),Math.round(s),Math.round(s+r))).isImage?u++:c++,h.push(t),d++;var l=r*o,g=this.totalRequiredTimeForReading,n=this.totalRequiredTimeForViewingImage;return this._setRecalculatedValueToPartitions({partitions:h,textSpeed:c*l/g,imageSpeed:u*l/n,textTime:g/c,imageTime:n/u}),{partitions:h,area:l,textPartitionCount:c,imagePartitionCount:u}},_setRecalculatedValueToPartitions:function(t){for(var e,i,s=(t=t||{}).partitions,n=t.textSpeed,r=t.imageSpeed,a=t.textTime,o=t.imageTime,h=0,d=s.length;h<d;h++)i=(e=s[h]).isImage,e.speed=!0===i?r:n,e.requiredTime=!0===i?o:a},_generatePartition:function(t,e,i,s){var n=s-i,r=e-t;return new a.Partition({width:n,height:r,top:t,left:i,right:s,bottom:e,isImage:this._isImagePartition(t,e,n,r)})},_isImagePartition:function(t,e,i,s){return this._calculateImageCoveredTotalPercentage(t,e,i,s,this.containedImageNodes)>this.imageAreaPercentage},_calculateImageCoveredTotalPercentage:function(t,e,i,s,n){for(var r=0,a=0,o=n.length;a<o;a++)r+=this._calculateImageCoveredPercentage(t,e,i,s,n[a]);return r},_calculateImageCoveredPercentage:function(t,e,i,s,n){var r=h.Common.Utils,a=r.getSize(n).width,r=r.getPosition(n),n=r.top,r=r.bottom;return t<=n&&n<e?(e-n)/s*a/i:t<=r&&r<=e?(r-t)/s*a/i:n<=t&&e<=r?a/i:0},_getVisiblePartition:function(t,e){return this.partitions.filter(this._checkPartitionVisibility.bind(null,t,e))},_checkPartitionVisibility:function(t,e,i){return i.checkVisible(t,e)&&i.currentPercentage<1},_calculateTotalPercentages:function(t){for(var e,i=t.length,s=0,n=0,r=0;r<i;)s+=(e=t[r]).currentPercentage,!0===e.isViewed&&n++,r++;return{currentReadingPercentage:Math.min(1,s/i),currentViewingPercentage:n/i}}})}(window.PopIn||{}),function(i){"use strict";i.createClass("Read.DebugStatusBar",function(t){this.width=(t=t||{}).width,this.height=t.height,this.x=t.x,this.y=t.y,this.textColour=t.textColour,this.imageColour=t.imageColour,this.opacity=t.opacity,this.incompletedOpacity=t.incompletedOpacity,this.completedOpacity=t.completedOpacity,this.node,this.lowerContext,this.upperContext,this.upperNode,this._textDrawn=!1},{CSS_OBJECT:{"._popIn_read_status_bar":{position:"absolute","box-shadow":"2px 2px 2px 2px #888888","border-radius":"10px",background:"#fff",overflow:"hidden","z-index":999999},"._popIn_read_status_bar_lower_canvas":{position:"relative",overflow:"hidden",opacity:.7,"z-index":0},"._popIn_read_status_bar_upper_canvas":{position:"absolute",overflow:"hidden",top:0,left:0,opacity:1,"z-index":1},"._popIn_read_status_bar.disabled":{display:"none"}},AREA_TEXT_FONT:"10px normal Meiryo, 'MS Gothic', sans-serif",TEXT_LABEL_NAME:"テキスト",IMAGE_LABEL_NAME:"画像",setup:function(){var t=i.Common,e=t.CSSManager;e.add(this.CSS_OBJECT),e.render();t=new t.NodeBuilder({tagName:"div",classList:"_popIn_read_status_bar",property:{style:{width:this.width+"px",height:this.height+"px",top:this.y+"px",left:this.x+"px",opacity:this.opacity}},children:[{tagName:"canvas",classList:"_popIn_read_status_bar_lower_canvas",property:{width:this.width,height:this.height}},{tagName:"canvas",classList:"_popIn_read_status_bar_upper_canvas",property:{width:this.width,height:this.height}}]}).build();this.lowerContext=t.querySelector("._popIn_read_status_bar_lower_canvas").getContext("2d"),this.upperContext=t.querySelector("._popIn_read_status_bar_upper_canvas").getContext("2d"),this.node=t},update:function(t){var e,i=t.partitions,s=this.lowerContext;!1===this._textDrawn&&(this._drawTextsInUpperCanvas(i),this._textDrawn=!0),s.clearRect(0,0,this.width,this.height);for(var n=0,r=i.length;n<r;n++)e=i[n],this._drawPartition(e,s)},_drawTextsInUpperCanvas:function(t){for(var e,i,s,n=this.upperContext,r=0,a=t.length;r<a;r++)s!==(i=(e=t[r]).isImage)&&(this._drawText(e,n),s=i)},_drawPartition:function(t,e){e.fillStyle=!0===t.isImage?this.imageColour:this.textColour,e.globalAlpha=1<=t.currentPercentage?this.completedOpacity:this.incompletedOpacity,e.fillRect(0,t.top-this.y,Math.floor(this.width*t.currentPercentage),t.height)},_drawText:function(t,e){e.font=this.AREA_TEXT_FONT,e.textAlign="center",e.fillStyle="#fff",e.fillText(t.isImage?this.IMAGE_LABEL_NAME:this.TEXT_LABEL_NAME,Math.round(this.width/2),t.bottom-this.y,this.width)}})}(window.PopIn||{}),function(r){"use strict";var a=r.Read;r.createClass("Read.DebugStatusMonitor",function(t){this.width=(t=t||{}).width,this.height=t.height,this.x=t.x,this.y=t.y,this.minY=t.minY,this.maxY=t.maxY,this.country=t.country,this.node},{CLASS_NAME_VIEWING_PERCENTAGE:"_popIn_debug_status_viewing_percentage",CLASS_NAME_READING_PERCENTAGE:"_popIn_debug_status_reading_percentage",CLASS_NAME_CURRENT_READING_TIME:"_popIn_debug_status_current_time",CSS_OBJECT:{"._popIn_read_debug_status_monitor":{position:"absolute",display:"flex",transition:"all 0.15s ease-in-out","flex-direction":"column","justify-content":"space-evenly","align-items":"self-start","box-shadow":"2px 2px 2px 2px #888888","border-radius":"10px",overflow:"hidden",background:"#d9534f","font-size":"15px","font-weight":600,"letter-spacing":"initial",color:"#fff","line-height":1.5,"list-style":"none",padding:"10px",margin:0,"box-sizing":"border-box","z-index":999999},"._popIn_read_debug_status_monitor > li":{display:"block","font-size":"inherit","font-weight":"inherit","line-height":"inherit",background:"transparent",color:"inherit"},"._popIn_read_debug_status_monitor.disabled":{display:"none"}},setup:function(){var t=r.Common,e=t.CSSManager;e.add(this.CSS_OBJECT),e.render();t=new t.NodeBuilder({tagName:"ul",classList:"_popIn_read_debug_status_monitor",property:{style:{top:this.y+"px",left:this.x+"px",width:this.width+"px",minHeight:this.height+"px"}},children:[{tagName:"li",classList:this.CLASS_NAME_VIEWING_PERCENTAGE},{tagName:"li",classList:this.CLASS_NAME_READING_PERCENTAGE},{tagName:"li",classList:this.CLASS_NAME_CURRENT_READING_TIME}]}).build();this._initialiseStatuses(t),this.node=t},_initialiseStatuses:function(t){var e,i,s=new r.Common.Message(this.country),n={viewingPercentage:{classList:this.CLASS_NAME_VIEWING_PERCENTAGE,format:s.get("read_debug_info_view")},readingPercentage:{classList:this.CLASS_NAME_READING_PERCENTAGE,format:s.get("read_debug_info_read")},currentReadingTime:{classList:this.CLASS_NAME_CURRENT_READING_TIME,format:s.get("read_debug_info_time")}};for(i in n)this[i]=new a.DebugStatus({node:t.querySelector("."+(e=n[i]).classList),format:e.format})},update:function(t,e){"object"==typeof t&&this._updateMonitor(t),this._move(e)},_updateMonitor:function(t){this.viewingPercentage.update(Math.round(100*t.currentViewingPercentage)),this.readingPercentage.update(Math.round(100*t.currentReadingPercentage)),this.currentReadingTime.update(Math.floor(t.currentReadingTime))},_move:function(t){this.y!==t&&(t=t>this.maxY?this.maxY:t<this.minY?this.minY:t,this.y=t,this.node.style.top=t+"px")}})}(window.PopIn||{}),function(){"use strict";(window.PopIn||{}).createClass("Read.DebugStatus",function(t){this.node=(t=t||{}).node,this.format=t.format,this.currentStatus=t.currentStatus||0},{update:function(t){this.currentStatus=t,this.node.textContent=this._formatValue(t)},_formatValue:function(t){return this.format.replace("{{value}}",t)}})}(),function(t,s){"use strict";var n=t.Read;t.createClass("Read.Debug",function(t){this.height=(t=t||{}).height,this.x=t.x,this.y=t.y,this.country=t.country,this.textColour=t.textColour||this.TEXT_COLOUR,this.imageColour=t.imageColour||this.IMAGE_COLOUR,this.statusBar,this.statusMonitor,this.enabled=!1},{BAR_WIDTH:45,MONITOR_WIDTH:140,MONITOR_HEIGHT:130,X_DISTANCE_FROM_ARTICLE:70,X_DISTANCE_BETWEEN_BAR_AND_MONITOR:10,TEXT_COLOUR:"#60C560",IMAGE_COLOUR:"#5BC0DE",BAR_OPACITY:1,OVERLAYED_BAR_OPACITY:.7,COMPLETED_OPACITY:1,INCOMPLETED_OPACITY:.6,MODULE_NAMES:["statusBar","statusMonitor"],setup:function(){var t=Math.max(this.x-this.X_DISTANCE_FROM_ARTICLE,0),e=new n.DebugStatusBar({width:this.BAR_WIDTH,height:this.height,x:t,y:this.y,opacity:0<t?this.BAR_OPACITY:this.OVERLAYED_BAR_OPACITY,imageColour:this.IMAGE_COLOUR,textColour:this.TEXT_COLOUR,incompletedOpacity:this.INCOMPLETED_OPACITY,completedOpacity:this.COMPLETED_OPACITY}),i=this.MONITOR_WIDTH+this.X_DISTANCE_BETWEEN_BAR_AND_MONITOR,i=new n.DebugStatusMonitor({width:this.MONITOR_WIDTH,height:this.MONITOR_HEIGHT,x:i<t?t-i:t+this.BAR_WIDTH+this.X_DISTANCE_BETWEEN_BAR_AND_MONITOR,y:this.y,minY:this.y,maxY:this.y+this.height-this.MONITOR_HEIGHT,country:this.country});e.setup(),i.setup();t=s.body;t.appendChild(e.node),t.appendChild(i.node),this.statusBar=e,this.statusMonitor=i,this.enabled=!0},update:function(t,e){"object"==typeof t&&this.statusBar.update(t),this.statusMonitor.update(t,e)},changeEnabled:function(t){for(var e,i=!0===(this.enabled=t)?"remove":"add",s=this.MODULE_NAMES,n=0,r=s.length;n<r;n++)void 0!==(e=this[s[n]])&&e.node.classList[i]("disabled")}})}(window.PopIn,document),function(){"use strict";(window.PopIn||{}).createClass("Read.Partition",function(t){this.width=(t=t||{}).width,this.height=t.height,this.top=t.top||0,this.right=t.right||0,this.left=t.left||0,this.bottom=t.bottom||0,this.speed=t.speed||0,this.requiredTime=t.requiredTime||0,this.isImage=t.isImage||!1,this.currentPercentage=0,this.currentTime=0,this.isFinished=!1,this.isViewed=!1,this.isUpdated=!1},{update:function(t){var e;!(this.isUpdated=!1)!==this.isFinished&&(e=this.currentPercentage,t=Math.min(1,e+t*this.speed),this.currentTime=this.requiredTime*t,this.isFinished=1<=t,this.isViewed=0<t,this.isUpdated=t!==e,this.currentPercentage=t)},checkVisible:function(t,e){return this.isVisible=this.top>t&&this.bottom<e}})}(),function(t,e,i){"use strict";t.inherit("Read.Timer","Common.Publisher",function(t){this.interval=(t=t||{}).interval||1,this.maxElapsed=t.maxElapsed||1,this.elapsed=0,this.currentTime,this._isStarted=!1,this._timer=null},{start:function(){null===this._timer&&(!1===this._isStarted&&(this._addEvent(),this._isStarted=!0),this.currentTime=Date.now(),this._timer=setInterval(this._update.bind(this),this.interval))},stop:function(){null!==this._timer&&(clearInterval(this._timer),this._timer=null)},_update:function(){var t=this.currentTime,e=Date.now(),t=(e-t)/1e3;this.currentTime=e,t>this.maxElapsed||(this.elapsed=t,this.trigger("update",this))},_addEvent:function(){e.addEventListener("visibilitychange",this._toggleActive.bind(this),!1)},_toggleActive:function(){!0===i.hidden?this.stop():this.start()}})}(window.PopIn,window,document),function(n,c,r,a){"use strict";var t=n.PROTOCOL;n.createClass("Read",["Common.Logger","Common.Publisher"],function(t){this.media=(t=t||{}).media||a.host,this.apiUrl=t.apiUrl,this.urlReplace=t.urlReplace||[],this.mainNode=t.mainNode,this.mainNodeElement=t.mainNodeElement,this.stopNode=t.stopNode,this.useUser=t.useUser||!1,this.ignoredNodeNames=t.ignoredNodeNames||void 0,this.category=t.category||!1,this.isMultiple=t.isMultiple||!1,this.shouldContinueToUpdate=t.shouldContinueToUpdate||!1,this.needRecommendInformation=t.needRecommendInformation||!1,this.customEvents=t.customEvents||void 0,this.textSpeed=t.textSpeed||this.DEFAULT_TEXT_SPEED,this.imageSpeed=t.imageSpeed||this.DEFAULT_IMAGE_SPEED,this.findingNodeInterval=t.findingNodeInterval||this.FINDING_NODE_INTERVAL,this.delay=t.delay||0,this.device,this.currentUrl,this.analyisStopNode,this.popInUserId,this.customValueMap,this.country,this.commonCategory=[],this.sendLogTiming,this.findNodeTiming,this.articleReadId,this.updateCount=0,this.delayAnalysis=!1,this.isAnalysing=!1;var e=this.constructor;void 0===e._analysedArticleNodes&&(e._analysedArticleNodes=[]),void 0===e._analysers&&(e._analysers=[]),void 0===e._isDebug&&(e._isDebug=!1),void 0===e._timer&&((t=new e.Timer({interval:this.UPDATE_INTERVAL,maxElapsed:this.VALID_MAX_ELAPSED})).on("update",this._update.bind(this)),e._timer=t)},{POPIN_AD_DOMAIN:"a.popin.cc",TRACE_AD_DOMAIN:"trace.popin.cc",CLICK_HISTORY_API_URL:t+"//discoveryplus.popin.cc/popin_discovery/ck?name=_click",TRACR_CLICK_HISTORY_API_URL:"https://trace.popin.cc/cs/ck?placeholder=''",DEFAULT_TEXT_SPEED:1e3/60,DEFAULT_IMAGE_SPEED:9e4,UPDATE_INTERVAL:100,VALID_MAX_ELAPSED:.15,SEND_LOG_INTERVAL:2e3,FINDING_NODE_INTERVAL:4e3,INTERVAL_TO_RETRY_ANALYSIS:100,MAX_ELAPSED_SECONDS_FROM_AD_CLICK:10,READ_TIMPSTAMP_SESSION_STORAGE_KEY:"__read_id",CAN_ANALYSE_SESSION_STORAGE_KEY:"__read_rand",PERCENTAGE_TO_ANALYSE:.5,setup:function(){var t=this.constructor;t._isDebug=t._isDebug||/popinread=true/.test(a.href),this.logger=n.Common.Logger,this.delayAnalysis=0<this.delay,this.sendLogTiming=Math.round(this.SEND_LOG_INTERVAL/this.UPDATE_INTERVAL),this.findNodeTiming=!0===this.isMultiple?Math.round(this.findingNodeInterval/this.UPDATE_INTERVAL):void 0,this.isClickedAd=-1<r.referrer.indexOf(this.POPIN_AD_DOMAIN)||-1<r.referrer.indexOf(this.TRACE_AD_DOMAIN);var e=n.Common.Storage;this.sessionHistory=e.get("session",t.Analyser.prototype.READ_HISTORY_SESSION_STORAGE_KEY);t=e.get("session",this.READ_TIMPSTAMP_SESSION_STORAGE_KEY);return this.isNewSession=null===t,!0===this.isNewSession&&(e.set("session",this.READ_TIMPSTAMP_SESSION_STORAGE_KEY,"s"+Date.now()),e.set("session",this.CAN_ANALYSE_SESSION_STORAGE_KEY,!0===this.isClickedAd||Math.random()<this.PERCENTAGE_TO_ANALYSE)),this.canAnalyse="true"===e.get("session",this.CAN_ANALYSE_SESSION_STORAGE_KEY),this.needRecommendInformation=this.needRecommendInformation||!0===this.category||!0===this.useUser,this.customValueMap=this._generateCustomValueMap(),this.analyisStopNode=this.stopNode?r.querySelector(this.stopNode):void 0,this.mainNodeElement?this._load(this.mainNodeElement):this._initialiseAnalyserBySelector(this.mainNode)},_initialiseAnalyserBySelector:function(t){t=r.querySelector(t);null!==t&&!1===this._isAnalysed(t)&&this._load(t)},_initialiseAnalysersBySelector:function(t){var e,i=Array.apply(null,r.querySelectorAll(t));if(0===i.length)return!1;for(var s=0,n=i.length;s<n;s++)e=i[s],!1===this._isAnalysed(e)&&this._load(e)},_load:function(t){this.constructor._analysedArticleNodes.push(t);var e=new n.Common.Loader({target:a.href,apiUrl:this.apiUrl,apiUrlAdd:"&related=false",urlReplace:this.urlReplace,needRecommendInformation:this.needRecommendInformation});e.on("response",this._onResponse.bind(this,t)),e.load()},_isAnalysed:function(t){return n.Common.Utils.includes(t,this.constructor._analysedArticleNodes)},_onResponse:function(t,e){this._updateInformation(e),!0===this.isClickedAd?-1<r.referrer.indexOf(this.TRACE_AD_DOMAIN)?n.Common.Utils.requestByJSONP(this.TRACR_CLICK_HISTORY_API_URL,this._onAdInformationResponse.bind(this,t)):n.Common.Utils.requestByJSONP(this.CLICK_HISTORY_API_URL,this._onAdInformationResponse.bind(this,t)):this._initialiseAnalyser(t)},_onAdInformationResponse:function(t,e){var i;"object"==typeof e&&"object"==typeof(i=-1<r.referrer.indexOf(this.TRACE_AD_DOMAIN)?this._getAdInformationForTrace(e):this._getAdInformation(e))&&this._initialiseAnalyser(t,i)},_getAdInformation:function(t){var e=JSON.parse(window.atob(t.cdata))._click;if(!e)return!1;var i=parseInt(t.time),s=e.split("|").pop().split(".");if(s.length<2)return!1;t=s[1],e=s[2];return(i-parseInt(e))/1e3<this.MAX_ELAPSED_SECONDS_FROM_AD_CLICK&&{campaign:s[0],nid:t,media:t,clickCategory:s[3]}},_getAdInformationForTrace:function(t){var e=t.clicks;if(!e)return!1;var i=parseInt(t.time),s=e.split("|").shift().split("_");if(s.length<2)return!1;var n=s[1],r=s[2],t=s[3],e=s[4];return i-parseInt(e)<9999999999&&{campaign:r,nid:t,media:n,clickCategory:"cc_"+(s[5]||"NONE")}},_updateInformation:function(t){this.currentUrl=t.target,this.device=t.device,this.referrer=t.referrer,this.popInUserId=t.popInUserId,this.country=t.country,this.apiHost=t.apiHost;t=t.responseData||{};this.pageCategory=t.category,this.commonCategory=t.common_category||[],this.articleReadId=t.article_read},_generateCustomValueMap:function(){var t,e,i={},s=c._pop;if(!s)return i;for(var n=0,r=s.length;n<r;n++)e=(t=s[n])[0],t=t[1],i[e.substring(5)]=t;return i},_initialiseAnalyser:function(t,e){if(e=e||{},!1===this._shouldAnalyse())return!1;if("complete"===r.readyState){if(!0===this.delayAnalysis)return setTimeout(this._initialiseAnalyser.bind(this,t,e),this.delay),void(this.delayAnalysis=!1);var i=this.constructor,s=n.Common.Utils,s=new i.Analyser({node:t,textSpeed:this.textSpeed,imageSpeed:this.imageSpeed,sendLogTiming:this.sendLogTiming,stopNode:this.analyisStopNode,media:e.media||this.media,campaign:e.campaign,clickCategory:e.clickCategory,device:this.device,sessionHistory:this.sessionHistory,nid:e.nid||s.digest(a.host)+s.digest(this.currentUrl),popInUserId:!0===this.useUser?this.popInUserId:"",commonCategory:this.commonCategory[0],apiHost:this.apiHost,ignoredNodeNames:this.ignoredNodeNames,pageCategory:this.customValueMap.read_categoryName||(!0===this.category?this.pageCategory||"all":void 0),customField:this.customValueMap.read_customField,url:this.currentUrl,urlReplace:this.urlReplace,country:this.country,referrer:this.referrer,isDebug:i._isDebug,isNewSession:this.isNewSession,isClickedAd:this.isClickedAd,articleReadId:this.articleReadId,logger:this.logger});"object"==typeof this.customEvents&&this._registerEvents(s,this.customEvents),s.setup(),i._analysers.push(s),!1===this.isAnalysing&&(i._timer.start(),this.isAnalysing=!0)}else setTimeout(this._initialiseAnalyser.bind(this,t,e),this.INTERVAL_TO_RETRY_ANALYSIS)},_shouldAnalyse:function(){return void 0!==this.articleReadId||!0===this.constructor._isDebug||!0===this.canAnalyse},_registerEvents:function(t,e){var i,s;for(s in e)"function"==typeof(i=e[s])&&t.on(s,i)},_update:function(t){this.updateCount++,!0===this.isMultiple&&this.updateCount%this.findNodeTiming==0&&this._initialiseAnalysersBySelector(this.mainNode);for(var e,i=c.pageYOffset,s=i+c.innerHeight,n=this.constructor,r=n._analysers,a=this.shouldContinueToUpdate,o=n._isDebug,h=t.elapsed,d=0,u=r.length;d<u;d++)(e=r[d]).update(h,i,s),!1===a&&!1===o&&!0===e.isCompleted&&(r.splice(d,1),d--,u--);!1===this.isMultiple&&0===r.length&&n._timer.stop()}})}(window.PopIn,window,document,location);